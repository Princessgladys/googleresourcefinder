{% comment %}
# Copyright 2009-2010 by Ka-Ping Yee
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
{% endcomment %}
      <script type="text/html" id="bubble_tmpl">
        <div id="bubble">
          <h1><%=facility.title%></h1>
          <div class="bubble-l2">
            <div class="bubble-l2-inner">
              Facility ID: <%=facility.id%> |
            </div>
            <div class="bubble-l2-inner">
              Updated <%=last_updated%> |
            </div>
            <% if (rmapper.user && rmapper.user.is_editor()) { %>
            <div class="edit-links bubble-l2-inner"> 
              <a href="#" class="edit-ip-link" 
                         onclick="edit_handler('/edit?cc=ht&facility_name=<%=facility.name%>&embed=yes');">
                Edit this record
              </a>
              <a href="/edit?cc=ht&facility_name=<%=facility.name%>">
                <img src="static/new-window.png" class="new_window">
              </a> \u00b7 
            </div>
            <% } else if (rmapper.user) { %>
            <div class="request-edit" >
              <a href="#" class="edit-ip-link" 
                         onclick="request_role_handler/request_access?cc=ht&role=editor&embed=yes');">
                Request to become editor
              </a>
            </div>
            <% } else { %>
            <div class="please-signin">
              Please sign in as editor to edit
            </div>
            <% } %>
          </div>
          <div class="bubble-main-info">
            <hr>
            <table>
              <tbody>
                <tr class=bubble-info-head>
                  <% if (availability || availability == 0) { %>
                  <td class="bubble-info-ava"> availability </td>
                  <td> capacity </td>
                  <% } else {%>
                  <td class="bubble-info-no-numbers" rowspan="2">
                    Please call for availability information
                  </td>
                  <% } %>
                  <td> services </td>
                </tr>
                <tr>
                  <% if (availability || availability == 0) { %>
                  <td class="bubble-info-number bubble-info-ava"> <%=availability%> </td>
                  <td class="bubble-info-number"> <%=capacity%> </td>
                  <% } %>
                  <td class="bubble-info-serv">
                    <%=services_list %>
                  </td>
                </tr>
              </tbody>
            </table>
            <hr>
          </div>
          <div id="tabs-in-bubble">
            <ul>
              <li ><a href="#tabs-in-bubble-1">Facility Details</a></li> 
              <li ><a href="#tabs-in-bubble-2">Change History</a></li>
            </ul>
            <div id="tabs-in-bubble-1" >
              <table>
                <tbody id="bubble_attributes_body">
                  <tr class="item">
                    <td class="bubble_attr_title">
                      <%=messages.attribute_name['address'].en%> </td>
                    <td class="bubble_attr_value">
                      Tabarra 41, Port-au-prince, Haiti
                    </td>
                    <td class="bubble_attr_value">
                      Latitude: <%=facility.location.lat%><br>
                      Longitude: <%=facility.location.lon%>
                    </td>
                  </tr>
                  <% for ( var i = 0; i < attribute_is.length; i++ ) {
                       var a = attribute_is[i];
                       var attribute = attributes[a];
                  %>

                  <tr class="item">
                    <td class="bubble_attr_title">
                      <%=messages.attribute_name[attribute.name].en%> </td>
                    <td class="bubble_attr_value" colspan="2">
                      <% if (facility.last_report) { %>
                        <%=rmapper.bubble.format_attr(attribute, facility.last_report.values[a])%>
                      <% } %>
                    </td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            <div id="tabs-in-bubble-2" >
              <table>
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>Change</th>
                    <th>Edit By</th>
                  </tr>
                </thead>
                <tbody>
                    <% if (facility.reports) {
                         for (var i = facility.reports.length-1; i >= 0; i--) {
                           var r = facility.reports[i];
                           for ( var j = 0; j < attribute_is.length; j++ ) {
                             var a = attribute_is[j];
                             if (r.values[a] || r.values[a] == 0) {
                               var attribute = attributes[a];
                    %>
                  <tr>
                    <td><%=r.date%></td>
                    <td><%=messages.attribute_name[attribute.name].en%>
                      was updated</td>
                    <td><%=r.user.nickname%></td>
                  </tr>
                          <% } %>
                        <% } %>
                      <% } %>
                    <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>';
      </script>
      
