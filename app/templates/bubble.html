{% comment %}
# Copyright 2009-2010 by Ka-Ping Yee
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
{% endcomment %}
      <script type="text/html" id="bubble_tmpl">
        <div class="bubble">
          <h1><%=facility.title%></h1>
          <h2>
            Facility ID: <%=facility.name%> \u00b7
            <%=last_updated%> \u00b7
            <% if (rmapper.user && rmapper.user.is_editor()) { %>
              <a href="/edit?cc=ht&facility_name=<%=facility.name%>">
                Edit this record</a>
            <% } else if (rmapper.user) { %>
              <a href="#"
                 onclick="request_role_handler(/request_access?cc=ht&role=editor&embed=yes');">
                Request edit access</a>
            <% } else { %>
              Please sign in to edit
            <% } %>
          </h2>
          <table class="scorecard" cellpadding="0" cellspacing="0">
            <tbody>
              <tr>
                <th class="availability" width="1%"><div>availability</div></th>
                <th class="capacity" width="1%"><div>capacity</div></th>
                <th class="services"><div>services</div></th>
              </tr>
              <tr>
                <% if (availability === null) { %>
                  <td class="no-information" colspan="2">
                    Please call for availability information
                  </th>
                <% } else {%>
                  <td class="availability"
                      ><div class="number"><%=availability%></div></td>
                  <td class="capacity"
                      ><div class="number"><%=capacity%></div></td>
                <% } %>
                <td class="services">
                  <%=services_list%>
                </td>
              </tr>
            </tbody>
          </table>
          <div id="bubble-tabs">
            <ul>
              <li><a href="#bubble-tab-details">Facility details</a></li> 
              <li><a href="#bubble-tab-history">Change history</a></li>
            </ul>
            <div id="bubble-tab-details">
              <table class="details" cellpadding="0" cellspacing="0">
                <tbody>
                  <tr class="item">
                    <td class="label" width="20%">
                      <%=messages.attribute_name['address'].en%> </td>
                    <td class="value">
                      Tabarra 41, Port-au-prince, Haiti
                    </td>
                    <td class="value">
                      Latitude: <%=facility.location.lat%><br>
                      Longitude: <%=facility.location.lon%>
                    </td>
                  </tr>
                  <% for (var i = 0; i < attribute_is.length; i++) {
                       var a = attribute_is[i];
                       var attribute = attributes[a];
                       var value = null;
                       if (facility.last_report) {
                         value = facility.last_report.values[a];
                       }
                       if (value !== null && value !== '') { %>
                        <tr class="item">
                          <td class="label">
                            <%=messages.attribute_name[attribute.name].en%>
                          </td>
                          <td class="value" colspan="2">
                            <%=rmapper.bubble.format_attr(attribute, value)%>
                          </td>
                        </tr>
                    <% } %>
                  <% } %>
                </tbody>
              </table>
            </div>
            <div id="bubble-tab-history">
              <table>
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>Change</th>
                    <th>Edit By</th>
                  </tr>
                </thead>
                <tbody>
                    <% if (facility.reports) {
                         for (var i = facility.reports.length-1; i >= 0; i--) {
                           var report = facility.reports[i];
                           for ( var j = 0; j < attribute_is.length; j++ ) {
                             var a = attribute_is[j];
                             if (report.values[a] || report.values[a] == 0) {
                               var attribute = attributes[a];
                    %>
                            <tr>
                              <td><%=report.date%></td>
                              <td>
                                <%=messages.attribute_name[attribute.name].en%>
                                was updated
                              </td>
                              <td><%=report.user.nickname%></td>
                            </tr>
                          <% } %>
                        <% } %>
                      <% } %>
                    <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </script>
      
